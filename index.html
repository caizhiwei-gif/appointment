<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ²»ç–—é¢„çº¦ç³»ç»Ÿ</title>
    <!-- LeanCloud SDK -->
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.2/dist/av-min.js"></script>
    <!-- QRCodeç”Ÿæˆ -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <!-- SheetJS for Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #4F46E5;
            --primary-dark: #4338CA;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-500: #6B7280;
            --gray-700: #374151;
            --gray-900: #111827;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--gray-100);
            min-height: 100vh;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--gray-200);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ç™»å½•é¡µé¢ */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .auth-card {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            width: 100%;
            max-width: 420px;
        }

        .auth-card h1 {
            text-align: center;
            color: var(--gray-900);
            margin-bottom: 8px;
            font-size: 28px;
        }

        .auth-card .subtitle {
            text-align: center;
            color: var(--gray-500);
            margin-bottom: 32px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: var(--gray-700);
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79,70,229,0.1);
        }

        .form-group input.error {
            border-color: var(--danger);
        }

        .form-group .error-msg {
            color: var(--danger);
            font-size: 12px;
            margin-top: 4px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        .btn-secondary:hover {
            background: var(--gray-300);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* ä¸»å¸ƒå±€ */
        .app-layout {
            display: none;
            min-height: 100vh;
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 260px;
            background: var(--gray-900);
            padding: 20px 0;
            overflow-y: auto;
            z-index: 100;
        }

        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
        }

        .sidebar-header h2 {
            color: white;
            font-size: 20px;
        }

        .sidebar-header .user-info {
            color: var(--gray-300);
            font-size: 13px;
            margin-top: 8px;
        }

        .sidebar-header .user-role {
            display: inline-block;
            padding: 2px 8px;
            background: var(--primary);
            color: white;
            border-radius: 4px;
            font-size: 11px;
            margin-top: 4px;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            padding: 12px 24px;
            color: var(--gray-300);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 15px;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.05);
            color: white;
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
        }

        .nav-item svg {
            width: 20px;
            height: 20px;
        }

        .nav-divider {
            height: 1px;
            background: rgba(255,255,255,0.1);
            margin: 16px 0;
        }

        .main-content {
            margin-left: 260px;
            padding: 24px;
            min-height: 100vh;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .page-header h1 {
            font-size: 24px;
            color: var(--gray-900);
        }

        .page-header .actions {
            display: flex;
            gap: 12px;
        }

        /* å¡ç‰‡ */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 24px;
            margin-bottom: 24px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--gray-200);
        }

        .card-header h2 {
            font-size: 18px;
            color: var(--gray-900);
        }

        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .stat-card .label {
            color: var(--gray-500);
            font-size: 14px;
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
            color: var(--gray-900);
        }

        .stat-card.primary .value {
            color: var(--primary);
        }

        .stat-card.success .value {
            color: var(--success);
        }

        .stat-card.warning .value {
            color: var(--warning);
        }

        /* è¡¨æ ¼ */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }

        th {
            background: var(--gray-50);
            font-weight: 600;
            color: var(--gray-700);
            font-size: 14px;
        }

        td {
            color: var(--gray-700);
            font-size: 14px;
        }

        tr:hover {
            background: var(--gray-50);
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-pending {
            background: #FEF3C7;
            color: #92400E;
        }

        .badge-confirmed {
            background: #D1FAE5;
            color: #065F46;
        }

        .badge-cancelled {
            background: #FEE2E2;
            color: #991B1B;
        }

        /* é¢„çº¦è¡¨å• */
        .booking-form {
            max-width: 600px;
        }

        .time-slots {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
            margin-top: 8px;
        }

        .time-slot {
            padding: 12px;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .time-slot:hover:not(.disabled) {
            border-color: var(--primary);
        }

        .time-slot.selected {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .time-slot.disabled {
            background: var(--gray-100);
            color: var(--gray-400);
            cursor: not-allowed;
        }

        .time-slot .slot-time {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .time-slot .slot-available {
            font-size: 12px;
            color: var(--gray-500);
        }

        .time-slot.selected .slot-available {
            color: rgba(255,255,255,0.8);
        }

        /* æ—¥æœŸé€‰æ‹©å™¨ */
        .date-picker {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-top: 8px;
        }

        .date-picker .day-name {
            text-align: center;
            font-size: 12px;
            color: var(--gray-500);
            padding: 8px 0;
        }

        .date-picker .date-item {
            padding: 12px 8px;
            text-align: center;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .date-picker .date-item:hover:not(.disabled) {
            border-color: var(--primary);
        }

        .date-picker .date-item.selected {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .date-picker .date-item.disabled {
            background: var(--gray-100);
            color: var(--gray-400);
            cursor: not-allowed;
        }

        .date-picker .date-item .date-num {
            font-size: 16px;
            font-weight: 600;
        }

        .date-picker .date-item .date-weekday {
            font-size: 11px;
            margin-top: 4px;
        }

        /* ä»ªè¡¨ç›˜ */
        .dashboard-filters {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .dashboard-filters .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dashboard-filters label {
            font-weight: 500;
            color: var(--gray-700);
        }

        .dashboard-filters select,
        .dashboard-filters input {
            padding: 8px 12px;
            border: 2px solid var(--gray-200);
            border-radius: 6px;
            font-size: 14px;
        }

        .project-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .project-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .project-card h3 {
            font-size: 18px;
            color: var(--gray-900);
            margin-bottom: 16px;
        }

        .slot-status {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--gray-100);
        }

        .slot-status:last-child {
            border-bottom: none;
        }

        .slot-status .slot-name {
            font-weight: 500;
        }

        .slot-status .slot-count {
            display: flex;
            gap: 8px;
        }

        .slot-status .available {
            color: var(--success);
        }

        .slot-status .booked {
            color: var(--primary);
        }

        /* æ¨¡æ€æ¡† */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 20px;
            color: var(--gray-900);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray-500);
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--gray-200);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* äºŒç»´ç åŒºåŸŸ */
        .qr-section {
            text-align: center;
            padding: 24px;
        }

        .qr-section canvas {
            margin: 20px auto;
            display: block;
        }

        .share-link {
            background: var(--gray-100);
            padding: 12px;
            border-radius: 8px;
            word-break: break-all;
            font-size: 14px;
            color: var(--gray-700);
            margin-top: 16px;
        }

        /* ç­›é€‰åŒºåŸŸ */
        .filter-bar {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 20px;
        }

        .filter-bar input,
        .filter-bar select {
            padding: 8px 12px;
            border: 2px solid var(--gray-200);
            border-radius: 6px;
            font-size: 14px;
        }

        /* åˆ†é¡µ */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 16px;
            border: 2px solid var(--gray-200);
            background: white;
            border-radius: 6px;
            cursor: pointer;
        }

        .pagination button.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* æç¤ºæ¶ˆæ¯ */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            background: var(--gray-900);
            color: white;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 2000;
            transform: translateX(120%);
            transition: transform 0.3s;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            background: var(--success);
        }

        .toast.error {
            background: var(--danger);
        }

        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .mobile-header {
                display: flex !important;
                padding: 16px;
                background: white;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                margin-bottom: 20px;
                border-radius: 0;
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        .mobile-header {
            display: none;
            align-items: center;
            gap: 16px;
        }

        .hamburger {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
        }

        .hidden {
            display: none !important;
        }

        /* é…ç½®æ—¶æ®µç¼–è¾‘å™¨ */
        .slot-editor {
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .slot-editor-row {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 12px;
        }

        .slot-editor-row input {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid var(--gray-200);
            border-radius: 6px;
        }

        .slot-editor-row button {
            padding: 8px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .add-slot-btn {
            width: 100%;
            padding: 12px;
            border: 2px dashed var(--gray-300);
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            color: var(--gray-500);
            font-size: 14px;
        }

        .add-slot-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        /* å¤šé€‰å¤é€‰æ¡† */
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input {
            width: 18px;
            height: 18px;
        }
    </style>
</head>
<body>
    <!-- åŠ è½½ä¸­ -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- æç¤ºæ¶ˆæ¯ -->
    <div class="toast" id="toast"></div>

    <!-- ç™»å½•é¡µé¢ -->
    <div class="auth-container" id="authPage">
        <div class="auth-card">
            <h1>ğŸ¥ æ²»ç–—é¢„çº¦ç³»ç»Ÿ</h1>
            <p class="subtitle">è¯·ç™»å½•æ‚¨çš„è´¦æˆ·</p>
            
            <form id="loginForm">
                <div class="form-group">
                    <label>ç”¨æˆ·å</label>
                    <input type="text" id="loginUsername" required placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                </div>
                <div class="form-group">
                    <label>å¯†ç </label>
                    <input type="password" id="loginPassword" required placeholder="è¯·è¾“å…¥å¯†ç ">
                </div>
                <button type="submit" class="btn btn-primary">ç™» å½•</button>
            </form>
        </div>
    </div>

    <!-- ä¸»åº”ç”¨ -->
    <div class="app-layout" id="appLayout">
        <!-- ä¾§è¾¹æ  -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>ğŸ¥ é¢„çº¦ç³»ç»Ÿ</h2>
                <div class="user-info" id="userInfo">
                    æ¬¢è¿ï¼Œ<span id="currentUsername">ç”¨æˆ·</span>
                </div>
                <span class="user-role" id="userRoleBadge">æ™®é€šç”¨æˆ·</span>
            </div>
            
            <ul class="nav-menu">
                <li class="nav-item active" data-page="booking">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                    </svg>
                    æ–°å¢é¢„çº¦
                </li>
                <li class="nav-item" data-page="dashboard">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    é¢„çº¦çœ‹æ¿
                </li>
                <li class="nav-item" data-page="myRecords">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                    </svg>
                    æˆ‘çš„é¢„çº¦
                </li>
                <li class="nav-item" data-page="share">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/>
                    </svg>
                    åˆ†äº«é“¾æ¥
                </li>
                
                <li class="nav-divider admin-only"></li>
                
                <li class="nav-item admin-only" data-page="records">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                    </svg>
                    é¢„çº¦è®°å½•
                </li>
                <li class="nav-item admin-only" data-page="projects">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    é¡¹ç›®é…ç½®
                </li>
                
                <li class="nav-divider super-admin-only"></li>
                
                <li class="nav-item super-admin-only" data-page="users">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                    </svg>
                    ç”¨æˆ·ç®¡ç†
                </li>
                
                <li class="nav-divider"></li>
                
                <li class="nav-item" id="logoutBtn">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                    </svg>
                    é€€å‡ºç™»å½•
                </li>
            </ul>
        </nav>

        <!-- ä¸»å†…å®¹åŒº -->
        <main class="main-content">
            <!-- ç§»åŠ¨ç«¯å¤´éƒ¨ -->
            <div class="mobile-header card">
                <button class="hamburger" id="menuToggle">â˜°</button>
                <h2>æ²»ç–—é¢„çº¦ç³»ç»Ÿ</h2>
            </div>

            <!-- æ–°å¢é¢„çº¦é¡µé¢ -->
            <section class="page" id="page-booking">
                <div class="page-header">
                    <h1>æ–°å¢é¢„çº¦</h1>
                </div>
                
                <div class="card">
                    <form id="bookingForm" class="booking-form">
                        <div class="form-group">
                            <label>é¡¾å®¢å§“å *</label>
                            <input type="text" id="customerName" required placeholder="è¯·è¾“å…¥é¡¾å®¢å§“å">
                        </div>
                        
                        <div class="form-group">
                            <label>è”ç³»ç”µè¯ *</label>
                            <input type="tel" id="customerPhone" required placeholder="è¯·è¾“å…¥11ä½æ‰‹æœºå·ç ">
                            <div class="error-msg" id="phoneError"></div>
                        </div>
                        
                        <div class="form-group">
                            <label>é¢„çº¦é¡¹ç›® *</label>
                            <select id="projectSelect" required>
                                <option value="">è¯·é€‰æ‹©é¢„çº¦é¡¹ç›®</option>
                            </select>
                        </div>
                        
                        <div class="form-group" id="dateGroup" style="display:none;">
                            <label>é¢„çº¦æ—¥æœŸ *</label>
                            <div class="date-picker" id="datePicker"></div>
                        </div>
                        
                        <div class="form-group" id="slotGroup" style="display:none;">
                            <label>é¢„çº¦æ—¶æ®µ *</label>
                            <div class="time-slots" id="timeSlots"></div>
                        </div>
                        
                        <div class="form-group">
                            <label>å¤‡æ³¨ä¿¡æ¯</label>
                            <textarea id="remarks" rows="3" placeholder="é€‰å¡«ï¼Œå¦‚æœ‰ç‰¹æ®Šéœ€æ±‚è¯·æ³¨æ˜"></textarea>
                        </div>
                        
                        <button type="submit" class="btn btn-primary" id="submitBooking" disabled>
                            æäº¤é¢„çº¦
                        </button>
                    </form>
                </div>
            </section>

            <!-- é¢„çº¦çœ‹æ¿é¡µé¢ -->
            <section class="page hidden" id="page-dashboard">
                <div class="page-header">
                    <h1>é¢„çº¦çœ‹æ¿</h1>
                </div>
                
                <div class="dashboard-filters">
                    <div class="filter-group">
                        <label>é€‰æ‹©æ—¥æœŸï¼š</label>
                        <input type="date" id="dashboardDate">
                    </div>
                    <div class="filter-group">
                        <label>é€‰æ‹©æ—¶æ®µï¼š</label>
                        <select id="dashboardSlot">
                            <option value="">å…¨éƒ¨æ—¶æ®µ</option>
                        </select>
                    </div>
                    <button class="btn btn-secondary btn-small" id="refreshDashboard">åˆ·æ–°</button>
                </div>
                
                <div class="stats-grid" id="dashboardStats">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>
                
                <div class="project-dashboard" id="projectDashboard">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </section>

            <!-- æˆ‘çš„é¢„çº¦é¡µé¢ -->
            <section class="page hidden" id="page-myRecords">
                <div class="page-header">
                    <h1>æˆ‘çš„é¢„çº¦</h1>
                </div>
                
                <div class="card">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>é¡¾å®¢å§“å</th>
                                    <th>ç”µè¯</th>
                                    <th>é¡¹ç›®</th>
                                    <th>æ—¥æœŸ</th>
                                    <th>æ—¶æ®µ</th>
                                    <th>çŠ¶æ€</th>
                                    <th>åˆ›å»ºæ—¶é—´</th>
                                </tr>
                            </thead>
                            <tbody id="myRecordsTable">
                                <!-- åŠ¨æ€ç”Ÿæˆ -->
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination" id="myRecordsPagination"></div>
                </div>
            </section>

            <!-- åˆ†äº«é“¾æ¥é¡µé¢ -->
            <section class="page hidden" id="page-share">
                <div class="page-header">
                    <h1>åˆ†äº«é¢„çº¦é“¾æ¥</h1>
                </div>
                
                <div class="card">
                    <div class="qr-section">
                        <h3>æ‰«æäºŒç»´ç è®¿é—®é¢„çº¦ç³»ç»Ÿ</h3>
                        <canvas id="qrcode"></canvas>
                        <p>æˆ–å¤åˆ¶ä»¥ä¸‹é“¾æ¥åˆ†äº«ï¼š</p>
                        <div class="share-link" id="shareLink"></div>
                        <button class="btn btn-primary" style="margin-top: 16px" onclick="copyShareLink()">
                            å¤åˆ¶é“¾æ¥
                        </button>
                    </div>
                </div>
            </section>

            <!-- é¢„çº¦è®°å½•é¡µé¢ï¼ˆç®¡ç†å‘˜ï¼‰ -->
            <section class="page hidden admin-only" id="page-records">
                <div class="page-header">
                    <h1>é¢„çº¦è®°å½•ç®¡ç†</h1>
                    <div class="actions">
                        <button class="btn btn-secondary btn-small" onclick="exportRecords()">
                            ğŸ“¥ å¯¼å‡ºExcel
                        </button>
                        <button class="btn btn-danger btn-small super-admin-only" onclick="showBatchDelete()">
                            ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="filter-bar">
                        <input type="text" id="searchName" placeholder="é¡¾å®¢å§“å">
                        <input type="text" id="searchPhone" placeholder="ç”µè¯å·ç ">
                        <select id="searchProject">
                            <option value="">å…¨éƒ¨é¡¹ç›®</option>
                        </select>
                        <input type="date" id="searchDateStart" placeholder="å¼€å§‹æ—¥æœŸ">
                        <span>è‡³</span>
                        <input type="date" id="searchDateEnd" placeholder="ç»“æŸæ—¥æœŸ">
                        <select id="searchStatus">
                            <option value="">å…¨éƒ¨çŠ¶æ€</option>
                            <option value="pending">å¾…ç¡®è®¤</option>
                            <option value="confirmed">å·²ç¡®è®¤</option>
                            <option value="cancelled">å·²å–æ¶ˆ</option>
                        </select>
                        <button class="btn btn-primary btn-small" onclick="searchRecords()">æœç´¢</button>
                        <button class="btn btn-secondary btn-small" onclick="resetSearch()">é‡ç½®</button>
                    </div>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th class="super-admin-only"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                                    <th>é¡¾å®¢å§“å</th>
                                    <th>ç”µè¯</th>
                                    <th>é¡¹ç›®</th>
                                    <th>æ—¥æœŸ</th>
                                    <th>æ—¶æ®µ</th>
                                    <th>çŠ¶æ€</th>
                                    <th>é¢„çº¦äºº</th>
                                    <th>ç™»è®°è´¦æˆ·</th>
                                    <th>åˆ›å»ºæ—¶é—´</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="recordsTable">
                                <!-- åŠ¨æ€ç”Ÿæˆ -->
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination" id="recordsPagination"></div>
                </div>
            </section>

            <!-- é¡¹ç›®é…ç½®é¡µé¢ï¼ˆç®¡ç†å‘˜ï¼‰ -->
            <section class="page hidden admin-only" id="page-projects">
                <div class="page-header">
                    <h1>é¡¹ç›®é…ç½®</h1>
                    <div class="actions">
                        <button class="btn btn-primary btn-small" onclick="showProjectModal()">
                            + æ–°å¢é¡¹ç›®
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>é¡¹ç›®åç§°</th>
                                    <th>å¯é¢„çº¦å¤©æ•°</th>
                                    <th>æ—¶æ®µé…ç½®</th>
                                    <th>çŠ¶æ€</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="projectsTable">
                                <!-- åŠ¨æ€ç”Ÿæˆ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ç”¨æˆ·ç®¡ç†é¡µé¢ï¼ˆè¶…çº§ç®¡ç†å‘˜ï¼‰ -->
            <section class="page hidden super-admin-only" id="page-users">
                <div class="page-header">
                    <h1>ç”¨æˆ·ç®¡ç†</h1>
                    <div class="actions">
                        <button class="btn btn-secondary btn-small" onclick="downloadUserTemplate()">
                            ğŸ“„ ä¸‹è½½æ¨¡æ¿
                        </button>
                        <button class="btn btn-secondary btn-small" onclick="document.getElementById('userImportFile').click()">
                            ğŸ“¤ å¯¼å…¥ç”¨æˆ·
                        </button>
                        <input type="file" id="userImportFile" accept=".xlsx,.xls" style="display:none" onchange="importUsers(this)">
                        <button class="btn btn-primary btn-small" onclick="showUserModal()">
                            + æ–°å¢ç”¨æˆ·
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ç”¨æˆ·å</th>
                                    <th>è§’è‰²</th>
                                    <th>åˆ›å»ºæ—¶é—´</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="usersTable">
                                <!-- åŠ¨æ€ç”Ÿæˆ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- é¡¹ç›®é…ç½®æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="projectModal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="projectModalTitle">æ–°å¢é¡¹ç›®</h2>
                <button class="modal-close" onclick="closeModal('projectModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="projectForm">
                    <input type="hidden" id="projectId">
                    <div class="form-group">
                        <label>é¡¹ç›®åç§° *</label>
                        <input type="text" id="projectName" required placeholder="å¦‚ï¼šé’ˆç¸æ²»ç–—">
                    </div>
                    <div class="form-group">
                        <label>å¯é¢„çº¦å¤©æ•° *</label>
                        <input type="number" id="projectDays" required min="1" max="90" value="10" placeholder="ä»ä»Šå¤©èµ·å¯é¢„çº¦çš„å¤©æ•°">
                    </div>
                    <div class="form-group">
                        <label>æ—¶æ®µé…ç½® *</label>
                        <div id="slotEditor">
                            <!-- åŠ¨æ€ç”Ÿæˆ -->
                        </div>
                        <button type="button" class="add-slot-btn" onclick="addSlotRow()">
                            + æ·»åŠ æ—¶æ®µ
                        </button>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="projectActive" checked>
                            å¯ç”¨æ­¤é¡¹ç›®
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('projectModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveProject()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- ç”¨æˆ·ç®¡ç†æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="userModal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="userModalTitle">æ–°å¢ç”¨æˆ·</h2>
                <button class="modal-close" onclick="closeModal('userModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <input type="hidden" id="userId">
                    <div class="form-group">
                        <label>ç”¨æˆ·å *</label>
                        <input type="text" id="newUsername" required placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                    </div>
                    <div class="form-group" id="passwordGroup">
                        <label>å¯†ç  *</label>
                        <input type="password" id="newPassword" placeholder="è¯·è¾“å…¥å¯†ç ">
                    </div>
                    <div class="form-group">
                        <label>è§’è‰² *</label>
                        <select id="newUserRole" required>
                            <option value="user">æ™®é€šç”¨æˆ·</option>
                            <option value="admin">ç®¡ç†å‘˜</option>
                            <option value="superadmin">è¶…çº§ç®¡ç†å‘˜</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('userModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveUser()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- æ‰¹é‡åˆ é™¤æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="batchDeleteModal">
        <div class="modal">
            <div class="modal-header">
                <h2>æ‰¹é‡åˆ é™¤ç¡®è®¤</h2>
                <button class="modal-close" onclick="closeModal('batchDeleteModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p>ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ <strong id="deleteCount">0</strong> æ¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('batchDeleteModal')">å–æ¶ˆ</button>
                <button class="btn btn-danger" onclick="confirmBatchDelete()">ç¡®è®¤åˆ é™¤</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== LeanCloud åˆå§‹åŒ– ====================
        AV.init({
            appId: "YJxnbplZZ54wic7X5mzG8ywE-gzGzoHsz",
            appKey: "XIXnl8r71cmH0qFt2R0vGgBh",
            serverURL: "https://yjxnbplz.lc-cn-n1-shared.com"
        });

        // ==================== å…¨å±€å˜é‡ ====================
        let currentUser = null;
        let userRole = 'user';
        let selectedRecords = new Set();
        let currentProjects = [];
        let selectedProject = null;
        let selectedDate = null;
        let selectedSlot = null;

        // ==================== å·¥å…·å‡½æ•° ====================
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show ' + type;
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function formatDate(date) {
            if (!date) return '';
            const d = new Date(date);
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        }

        function formatDateTime(date) {
            if (!date) return '';
            const d = new Date(date);
            return `${formatDate(d)} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
        }

        function validatePhone(phone) {
            return /^1[3-9]\d{9}$/.test(phone);
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        // ==================== è®¤è¯ç›¸å…³ ====================
        async function initApp() {
            showLoading();
            try {
                currentUser = AV.User.current();
                if (currentUser) {
                    await loadUserRole();
                    showApp();
                } else {
                    showAuth();
                }
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                showAuth();
            }
            hideLoading();
        }

        async function loadUserRole() {
            try {
                const roleQuery = new AV.Query('UserRole');
                roleQuery.equalTo('user', currentUser);
                const roleObj = await roleQuery.first();
                userRole = roleObj ? roleObj.get('role') : 'user';
            } catch (error) {
                console.error('è·å–è§’è‰²å¤±è´¥:', error);
                userRole = 'user';
            }
        }

        function showAuth() {
            document.getElementById('authPage').style.display = 'flex';
            document.getElementById('appLayout').style.display = 'none';
        }

        function showApp() {
            document.getElementById('authPage').style.display = 'none';
            document.getElementById('appLayout').style.display = 'block';
            
            document.getElementById('currentUsername').textContent = currentUser.get('username');
            
            // è®¾ç½®è§’è‰²æ˜¾ç¤º
            const roleNames = {
                'user': 'æ™®é€šç”¨æˆ·',
                'admin': 'ç®¡ç†å‘˜',
                'superadmin': 'è¶…çº§ç®¡ç†å‘˜'
            };
            document.getElementById('userRoleBadge').textContent = roleNames[userRole] || 'æ™®é€šç”¨æˆ·';
            
            // æ ¹æ®è§’è‰²æ˜¾ç¤º/éšè—èœå•
            document.querySelectorAll('.admin-only').forEach(el => {
                el.style.display = (userRole === 'admin' || userRole === 'superadmin') ? '' : 'none';
            });
            document.querySelectorAll('.super-admin-only').forEach(el => {
                el.style.display = userRole === 'superadmin' ? '' : 'none';
            });
            
            // åˆå§‹åŒ–é¡µé¢
            loadProjects();
            navigateTo('booking');
            generateShareQR();
        }

        // ç™»å½•
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();
            
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                currentUser = await AV.User.logIn(username, password);
                await loadUserRole();
                showToast('ç™»å½•æˆåŠŸï¼', 'success');
                showApp();
            } catch (error) {
                showToast('ç™»å½•å¤±è´¥ï¼š' + error.message, 'error');
            }
            hideLoading();
        });

        // é€€å‡ºç™»å½•
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await AV.User.logOut();
            currentUser = null;
            userRole = 'user';
            showAuth();
            showToast('å·²é€€å‡ºç™»å½•', 'success');
        });

        // ==================== å¯¼èˆªç›¸å…³ ====================
        document.querySelectorAll('.nav-item[data-page]').forEach(item => {
            item.addEventListener('click', () => {
                const page = item.getAttribute('data-page');
                navigateTo(page);
            });
        });

        function navigateTo(page) {
            // æ›´æ–°èœå•æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-page') === page) {
                    item.classList.add('active');
                }
            });
            
            // æ˜¾ç¤ºå¯¹åº”é¡µé¢
            document.querySelectorAll('.page').forEach(p => {
                p.classList.add('hidden');
            });
            document.getElementById('page-' + page).classList.remove('hidden');
            
            // åŠ è½½é¡µé¢æ•°æ®
            switch(page) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'myRecords':
                    loadMyRecords();
                    break;
                case 'records':
                    loadAllRecords();
                    break;
                case 'projects':
                    loadProjectsList();
                    break;
                case 'users':
                    loadUsers();
                    break;
            }
            
            // ç§»åŠ¨ç«¯å…³é—­ä¾§è¾¹æ 
            document.getElementById('sidebar').classList.remove('open');
        }

        // ç§»åŠ¨ç«¯èœå•åˆ‡æ¢
        document.getElementById('menuToggle').addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('open');
        });

        // ==================== é¡¹ç›®åŠ è½½ ====================
        async function loadProjects() {
            try {
                const query = new AV.Query('Project');
                query.equalTo('active', true);
                query.ascending('createdAt');
                currentProjects = await query.find();
                
                const select = document.getElementById('projectSelect');
                select.innerHTML = '<option value="">è¯·é€‰æ‹©é¢„çº¦é¡¹ç›®</option>';
                
                currentProjects.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = p.get('name');
                    select.appendChild(option);
                });
                
                // åŒæ—¶æ›´æ–°æœç´¢ä¸‹æ‹‰æ¡†
                const searchSelect = document.getElementById('searchProject');
                if (searchSelect) {
                    searchSelect.innerHTML = '<option value="">å…¨éƒ¨é¡¹ç›®</option>';
                    currentProjects.forEach(p => {
                        const option = document.createElement('option');
                        option.value = p.id;
                        option.textContent = p.get('name');
                        searchSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('åŠ è½½é¡¹ç›®å¤±è´¥:', error);
            }
        }

        // ==================== é¢„çº¦è¡¨å• ====================
        document.getElementById('projectSelect').addEventListener('change', async (e) => {
            const projectId = e.target.value;
            selectedProject = currentProjects.find(p => p.id === projectId);
            selectedDate = null;
            selectedSlot = null;
            
            if (selectedProject) {
                await renderDatePicker();
                document.getElementById('dateGroup').style.display = 'block';
                document.getElementById('slotGroup').style.display = 'none';
            } else {
                document.getElementById('dateGroup').style.display = 'none';
                document.getElementById('slotGroup').style.display = 'none';
            }
            updateSubmitButton();
        });

        async function renderDatePicker() {
            const container = document.getElementById('datePicker');
            container.innerHTML = '';
            
            const days = selectedProject.get('availableDays') || 10;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // è·å–è¯¥é¡¹ç›®å·²é¢„çº¦çš„æ•°æ®
            const bookings = await getProjectBookings();
            const slots = selectedProject.get('slots') || [];
            
            for (let i = 0; i < days; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() + i);
                const dateStr = formatDate(date);
                
                // æ£€æŸ¥è¿™å¤©æ˜¯å¦å·²çº¦æ»¡
                let totalAvailable = 0;
                slots.forEach(slot => {
                    const booked = countBookings(bookings, dateStr, slot.time);
                    totalAvailable += Math.max(0, slot.limit - booked);
                });
                
                const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
                const dateItem = document.createElement('div');
                dateItem.className = 'date-item' + (totalAvailable === 0 ? ' disabled' : '');
                dateItem.innerHTML = `
                    <div class="date-num">${date.getDate()}</div>
                    <div class="date-weekday">å‘¨${weekdays[date.getDay()]}</div>
                `;
                
                if (totalAvailable > 0) {
                    dateItem.addEventListener('click', () => selectDate(dateStr, dateItem));
                }
                
                container.appendChild(dateItem);
            }
        }

        async function selectDate(dateStr, element) {
            document.querySelectorAll('.date-item').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            selectedDate = dateStr;
            selectedSlot = null;
            
            await renderTimeSlots();
            document.getElementById('slotGroup').style.display = 'block';
            updateSubmitButton();
        }

        async function renderTimeSlots() {
            const container = document.getElementById('timeSlots');
            container.innerHTML = '';
            
            const slots = selectedProject.get('slots') || [];
            const bookings = await getProjectBookings();
            
            slots.forEach(slot => {
                const booked = countBookings(bookings, selectedDate, slot.time);
                const available = Math.max(0, slot.limit - booked);
                
                if (available > 0) {
                    const slotDiv = document.createElement('div');
                    slotDiv.className = 'time-slot';
                    slotDiv.innerHTML = `
                        <div class="slot-time">${slot.time}</div>
                        <div class="slot-available">å‰©ä½™ ${available} ä¸ª</div>
                    `;
                    slotDiv.addEventListener('click', () => selectSlot(slot.time, slotDiv));
                    container.appendChild(slotDiv);
                }
            });
            
            if (container.children.length === 0) {
                container.innerHTML = '<p style="color: var(--gray-500);">è¯¥æ—¥æœŸæ— å¯ç”¨æ—¶æ®µ</p>';
            }
        }

        function selectSlot(slotTime, element) {
            document.querySelectorAll('.time-slot').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            selectedSlot = slotTime;
            updateSubmitButton();
        }

        async function getProjectBookings() {
            if (!selectedProject) return [];
            
            const query = new AV.Query('Appointment');
            query.equalTo('projectId', selectedProject.id);
            query.notEqualTo('status', 'cancelled');
            return await query.find();
        }

        function countBookings(bookings, date, slot) {
            return bookings.filter(b => 
                b.get('appointmentDate') === date && 
                b.get('timeSlot') === slot
            ).length;
        }

        function updateSubmitButton() {
            const btn = document.getElementById('submitBooking');
            btn.disabled = !(selectedProject && selectedDate && selectedSlot);
        }

        // ç”µè¯éªŒè¯
        document.getElementById('customerPhone').addEventListener('input', (e) => {
            const phone = e.target.value;
            const errorEl = document.getElementById('phoneError');
            
            if (phone && !validatePhone(phone)) {
                e.target.classList.add('error');
                errorEl.textContent = 'è¯·è¾“å…¥æ­£ç¡®çš„11ä½æ‰‹æœºå·ç ';
            } else {
                e.target.classList.remove('error');
                errorEl.textContent = '';
            }
        });

        // æäº¤é¢„çº¦
        document.getElementById('bookingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const phone = document.getElementById('customerPhone').value;
            if (!validatePhone(phone)) {
                showToast('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·ç ', 'error');
                return;
            }
            
            if (!selectedProject || !selectedDate || !selectedSlot) {
                showToast('è¯·å®Œæ•´é€‰æ‹©é¢„çº¦ä¿¡æ¯', 'error');
                return;
            }
            
            showLoading();
            
            try {
                // å†æ¬¡éªŒè¯æ˜¯å¦è¿˜æœ‰åé¢
                const bookings = await getProjectBookings();
                const slots = selectedProject.get('slots') || [];
                const slotConfig = slots.find(s => s.time === selectedSlot);
                const booked = countBookings(bookings, selectedDate, selectedSlot);
                
                if (booked >= slotConfig.limit) {
                    showToast('è¯¥æ—¶æ®µå·²çº¦æ»¡ï¼Œè¯·é€‰æ‹©å…¶ä»–æ—¶æ®µ', 'error');
                    hideLoading();
                    await renderTimeSlots();
                    return;
                }
                
                // åˆ›å»ºé¢„çº¦è®°å½•
                const Appointment = AV.Object.extend('Appointment');
                const appointment = new Appointment();
                
                appointment.set('customerName', document.getElementById('customerName').value);
                appointment.set('customerPhone', phone);
                appointment.set('projectId', selectedProject.id);
                appointment.set('projectName', selectedProject.get('name'));
                appointment.set('appointmentDate', selectedDate);
                appointment.set('timeSlot', selectedSlot);
                appointment.set('remarks', document.getElementById('remarks').value);
                appointment.set('status', 'pending');
                appointment.set('bookedBy', currentUser.get('username'));
                appointment.set('bookedByUser', currentUser);
                
                await appointment.save();
                
                showToast('é¢„çº¦æˆåŠŸï¼', 'success');
                
                // é‡ç½®è¡¨å•
                document.getElementById('bookingForm').reset();
                document.getElementById('dateGroup').style.display = 'none';
                document.getElementById('slotGroup').style.display = 'none';
                selectedProject = null;
                selectedDate = null;
                selectedSlot = null;
                updateSubmitButton();
                
            } catch (error) {
                showToast('é¢„çº¦å¤±è´¥ï¼š' + error.message, 'error');
            }
            
            hideLoading();
        });

        // ==================== ä»ªè¡¨ç›˜ ====================
        async function loadDashboard() {
            const dateInput = document.getElementById('dashboardDate');
            if (!dateInput.value) {
                dateInput.value = formatDate(new Date());
            }
            
            // åŠ è½½æ—¶æ®µé€‰é¡¹
            const slotSelect = document.getElementById('dashboardSlot');
            slotSelect.innerHTML = '<option value="">å…¨éƒ¨æ—¶æ®µ</option>';
            
            const allSlots = new Set();
            currentProjects.forEach(p => {
                const slots = p.get('slots') || [];
                slots.forEach(s => allSlots.add(s.time));
            });
            
            Array.from(allSlots).sort().forEach(slot => {
                const option = document.createElement('option');
                option.value = slot;
                option.textContent = slot;
                slotSelect.appendChild(option);
            });
            
            await refreshDashboard();
        }

        document.getElementById('refreshDashboard').addEventListener('click', refreshDashboard);
        document.getElementById('dashboardDate').addEventListener('change', refreshDashboard);
        document.getElementById('dashboardSlot').addEventListener('change', refreshDashboard);

        async function refreshDashboard() {
            const dateStr = document.getElementById('dashboardDate').value;
            const slotFilter = document.getElementById('dashboardSlot').value;
            
            // è·å–è¯¥æ—¥æœŸçš„æ‰€æœ‰é¢„çº¦
            const query = new AV.Query('Appointment');
            query.equalTo('appointmentDate', dateStr);
            query.notEqualTo('status', 'cancelled');
            const bookings = await query.find();
            
            let totalAvailable = 0;
            let totalBooked = 0;
            
            const dashboardHtml = currentProjects.map(project => {
                const slots = project.get('slots') || [];
                let projectHtml = '';
                let projectAvailable = 0;
                let projectBooked = 0;
                
                slots.forEach(slot => {
                    if (slotFilter && slot.time !== slotFilter) return;
                    
                    const booked = bookings.filter(b => 
                        b.get('projectId') === project.id && 
                        b.get('timeSlot') === slot.time
                    ).length;
                    
                    const available = Math.max(0, slot.limit - booked);
                    
                    projectAvailable += available;
                    projectBooked += booked;
                    
                    projectHtml += `
                        <div class="slot-status">
                            <span class="slot-name">${slot.time}</span>
                            <span class="slot-count">
                                <span class="available">å¯é¢„çº¦: ${available}</span>
                                <span class="booked">å·²é¢„çº¦: ${booked}</span>
                            </span>
                        </div>
                    `;
                });
                
                totalAvailable += projectAvailable;
                totalBooked += projectBooked;
                
                return `
                    <div class="project-card">
                        <h3>${project.get('name')}</h3>
                        ${projectHtml || '<p style="color: var(--gray-500);">æ— æ—¶æ®µé…ç½®</p>'}
                    </div>
                `;
            }).join('');
            
            document.getElementById('projectDashboard').innerHTML = dashboardHtml;
            
            document.getElementById('dashboardStats').innerHTML = `
                <div class="stat-card primary">
                    <div class="label">å¯é¢„çº¦æ€»æ•°</div>
                    <div class="value">${totalAvailable}</div>
                </div>
                <div class="stat-card success">
                    <div class="label">å·²é¢„çº¦æ•°</div>
                    <div class="value">${totalBooked}</div>
                </div>
                <div class="stat-card warning">
                    <div class="label">é¢„çº¦ç‡</div>
                    <div class="value">${totalAvailable + totalBooked > 0 ? Math.round(totalBooked / (totalAvailable + totalBooked) * 100) : 0}%</div>
                </div>
            `;
        }

        // ==================== æˆ‘çš„é¢„çº¦ ====================
        async function loadMyRecords(page = 1) {
            const limit = 10;
            const skip = (page - 1) * limit;
            
            try {
                const query = new AV.Query('Appointment');
                query.equalTo('bookedByUser', currentUser);
                query.descending('createdAt');
                query.limit(limit);
                query.skip(skip);
                
                const [records, total] = await Promise.all([
                    query.find(),
                    query.count()
                ]);
                
                const tbody = document.getElementById('myRecordsTable');
                tbody.innerHTML = records.map(r => `
                    <tr>
                        <td>${r.get('customerName')}</td>
                        <td>${r.get('customerPhone')}</td>
                        <td>${r.get('projectName')}</td>
                        <td>${r.get('appointmentDate')}</td>
                        <td>${r.get('timeSlot')}</td>
                        <td><span class="badge badge-${r.get('status')}">${getStatusText(r.get('status'))}</span></td>
                        <td>${formatDateTime(r.createdAt)}</td>
                    </tr>
                `).join('') || '<tr><td colspan="7" style="text-align:center;color:var(--gray-500);">æš‚æ— é¢„çº¦è®°å½•</td></tr>';
                
                renderPagination('myRecordsPagination', total, page, limit, loadMyRecords);
                
            } catch (error) {
                console.error('åŠ è½½è®°å½•å¤±è´¥:', error);
            }
        }

        function getStatusText(status) {
            const texts = {
                'pending': 'å¾…ç¡®è®¤',
                'confirmed': 'å·²ç¡®è®¤',
                'cancelled': 'å·²å–æ¶ˆ'
            };
            return texts[status] || status;
        }

        function renderPagination(containerId, total, currentPage, limit, callback) {
            const container = document.getElementById(containerId);
            const totalPages = Math.ceil(total / limit);
            
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            let html = '';
            html += `<button ${currentPage === 1 ? 'disabled' : ''} onclick="(${callback.name})(${currentPage - 1})">ä¸Šä¸€é¡µ</button>`;
            
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    html += `<button class="${i === currentPage ? 'active' : ''}" onclick="(${callback.name})(${i})">${i}</button>`;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    html += '<span>...</span>';
                }
            }
            
            html += `<button ${currentPage === totalPages ? 'disabled' : ''} onclick="(${callback.name})(${currentPage + 1})">ä¸‹ä¸€é¡µ</button>`;
            
            container.innerHTML = html;
        }

        // ==================== åˆ†äº«é“¾æ¥ ====================
        function generateShareQR() {
            const url = window.location.href.split('?')[0];
            document.getElementById('shareLink').textContent = url;
            
            QRCode.toCanvas(document.getElementById('qrcode'), url, {
                width: 200,
                margin: 2
            });
        }

        function copyShareLink() {
            const url = window.location.href.split('?')[0];
            navigator.clipboard.writeText(url).then(() => {
                showToast('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            }).catch(() => {
                showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
            });
        }

        // ==================== é¢„çº¦è®°å½•ç®¡ç†ï¼ˆç®¡ç†å‘˜ï¼‰ ====================
        let recordsSearchParams = {};

        async function loadAllRecords(page = 1) {
            const limit = 15;
            const skip = (page - 1) * limit;
            
            try {
                const query = new AV.Query('Appointment');
                
                // åº”ç”¨ç­›é€‰æ¡ä»¶
                if (recordsSearchParams.name) {
                    query.contains('customerName', recordsSearchParams.name);
                }
                if (recordsSearchParams.phone) {
                    query.contains('customerPhone', recordsSearchParams.phone);
                }
                if (recordsSearchParams.project) {
                    query.equalTo('projectId', recordsSearchParams.project);
                }
                if (recordsSearchParams.dateStart) {
                    query.greaterThanOrEqualTo('appointmentDate', recordsSearchParams.dateStart);
                }
                if (recordsSearchParams.dateEnd) {
                    query.lessThanOrEqualTo('appointmentDate', recordsSearchParams.dateEnd);
                }
                if (recordsSearchParams.status) {
                    query.equalTo('status', recordsSearchParams.status);
                }
                
                query.descending('createdAt');
                query.limit(limit);
                query.skip(skip);
                
                const [records, total] = await Promise.all([
                    query.find(),
                    query.count()
                ]);
                
                const isSuperAdmin = userRole === 'superadmin';
                const tbody = document.getElementById('recordsTable');
                tbody.innerHTML = records.map(r => `
                    <tr>
                        ${isSuperAdmin ? `<td><input type="checkbox" class="record-checkbox" value="${r.id}" onchange="toggleRecordSelection('${r.id}')"></td>` : ''}
                        <td>${r.get('customerName')}</td>
                        <td>${r.get('customerPhone')}</td>
                        <td>${r.get('projectName')}</td>
                        <td>${r.get('appointmentDate')}</td>
                        <td>${r.get('timeSlot')}</td>
                        <td><span class="badge badge-${r.get('status')}">${getStatusText(r.get('status'))}</span></td>
                        <td>${r.get('bookedBy') || '-'}</td>
                        <td>${r.get('bookedBy') || '-'}</td>
                        <td>${formatDateTime(r.createdAt)}</td>
                        <td>
                            ${r.get('status') === 'pending' ? 
                                `<button class="btn btn-success btn-small" onclick="confirmAppointment('${r.id}')">ç¡®è®¤</button>` : 
                                ''}
                            ${isSuperAdmin ? 
                                `<button class="btn btn-danger btn-small" onclick="deleteAppointment('${r.id}')">åˆ é™¤</button>` : 
                                ''}
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="11" style="text-align:center;color:var(--gray-500);">æš‚æ— é¢„çº¦è®°å½•</td></tr>';
                
                renderPagination('recordsPagination', total, page, limit, loadAllRecords);
                
            } catch (error) {
                console.error('åŠ è½½è®°å½•å¤±è´¥:', error);
            }
        }

        function searchRecords() {
            recordsSearchParams = {
                name: document.getElementById('searchName').value,
                phone: document.getElementById('searchPhone').value,
                project: document.getElementById('searchProject').value,
                dateStart: document.getElementById('searchDateStart').value,
                dateEnd: document.getElementById('searchDateEnd').value,
                status: document.getElementById('searchStatus').value
            };
            loadAllRecords(1);
        }

        function resetSearch() {
            document.getElementById('searchName').value = '';
            document.getElementById('searchPhone').value = '';
            document.getElementById('searchProject').value = '';
            document.getElementById('searchDateStart').value = '';
            document.getElementById('searchDateEnd').value = '';
            document.getElementById('searchStatus').value = '';
            recordsSearchParams = {};
            loadAllRecords(1);
        }

        async function confirmAppointment(id) {
            try {
                const appointment = AV.Object.createWithoutData('Appointment', id);
                appointment.set('status', 'confirmed');
                await appointment.save();
                showToast('å·²ç¡®è®¤é¢„çº¦', 'success');
                loadAllRecords();
            } catch (error) {
                showToast('æ“ä½œå¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        async function deleteAppointment(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) return;
            
            try {
                const appointment = AV.Object.createWithoutData('Appointment', id);
                await appointment.destroy();
                showToast('å·²åˆ é™¤', 'success');
                loadAllRecords();
            } catch (error) {
                showToast('åˆ é™¤å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        function toggleRecordSelection(id) {
            if (selectedRecords.has(id)) {
                selectedRecords.delete(id);
            } else {
                selectedRecords.add(id);
            }
        }

        function toggleSelectAll() {
            const checked = document.getElementById('selectAll').checked;
            document.querySelectorAll('.record-checkbox').forEach(cb => {
                cb.checked = checked;
                if (checked) {
                    selectedRecords.add(cb.value);
                } else {
                    selectedRecords.delete(cb.value);
                }
            });
        }

        function showBatchDelete() {
            if (selectedRecords.size === 0) {
                showToast('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è®°å½•', 'error');
                return;
            }
            document.getElementById('deleteCount').textContent = selectedRecords.size;
            openModal('batchDeleteModal');
        }

        async function confirmBatchDelete() {
            showLoading();
            try {
                const objects = Array.from(selectedRecords).map(id => 
                    AV.Object.createWithoutData('Appointment', id)
                );
                await AV.Object.destroyAll(objects);
                showToast(`å·²åˆ é™¤ ${selectedRecords.size} æ¡è®°å½•`, 'success');
                selectedRecords.clear();
                closeModal('batchDeleteModal');
                loadAllRecords();
            } catch (error) {
                showToast('åˆ é™¤å¤±è´¥ï¼š' + error.message, 'error');
            }
            hideLoading();
        }

        async function exportRecords() {
            showLoading();
            try {
                const query = new AV.Query('Appointment');
                
                // åº”ç”¨å½“å‰ç­›é€‰æ¡ä»¶
                if (recordsSearchParams.name) query.contains('customerName', recordsSearchParams.name);
                if (recordsSearchParams.phone) query.contains('customerPhone', recordsSearchParams.phone);
                if (recordsSearchParams.project) query.equalTo('projectId', recordsSearchParams.project);
                if (recordsSearchParams.dateStart) query.greaterThanOrEqualTo('appointmentDate', recordsSearchParams.dateStart);
                if (recordsSearchParams.dateEnd) query.lessThanOrEqualTo('appointmentDate', recordsSearchParams.dateEnd);
                if (recordsSearchParams.status) query.equalTo('status', recordsSearchParams.status);
                
                query.descending('createdAt');
                query.limit(1000);
                
                const records = await query.find();
                
                const data = records.map(r => ({
                    'é¡¾å®¢å§“å': r.get('customerName'),
                    'ç”µè¯': r.get('customerPhone'),
                    'é¡¹ç›®': r.get('projectName'),
                    'é¢„çº¦æ—¥æœŸ': r.get('appointmentDate'),
                    'æ—¶æ®µ': r.get('timeSlot'),
                    'çŠ¶æ€': getStatusText(r.get('status')),
                    'å¤‡æ³¨': r.get('remarks') || '',
                    'é¢„çº¦äºº': r.get('bookedBy') || '',
                    'åˆ›å»ºæ—¶é—´': formatDateTime(r.createdAt)
                }));
                
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'é¢„çº¦è®°å½•');
                XLSX.writeFile(wb, `é¢„çº¦è®°å½•_${formatDate(new Date())}.xlsx`);
                
                showToast('å¯¼å‡ºæˆåŠŸ', 'success');
            } catch (error) {
                showToast('å¯¼å‡ºå¤±è´¥ï¼š' + error.message, 'error');
            }
            hideLoading();
        }

        // ==================== é¡¹ç›®é…ç½®ï¼ˆç®¡ç†å‘˜ï¼‰ ====================
        async function loadProjectsList() {
            try {
                const query = new AV.Query('Project');
                query.descending('createdAt');
                const projects = await query.find();
                
                const tbody = document.getElementById('projectsTable');
                tbody.innerHTML = projects.map(p => {
                    const slots = p.get('slots') || [];
                    const slotsText = slots.map(s => `${s.time}(${s.limit}äºº)`).join(', ');
                    
                    return `
                        <tr>
                            <td>${p.get('name')}</td>
                            <td>${p.get('availableDays')}å¤©</td>
                            <td>${slotsText || 'æœªé…ç½®'}</td>
                            <td><span class="badge ${p.get('active') ? 'badge-confirmed' : 'badge-cancelled'}">${p.get('active') ? 'å¯ç”¨' : 'åœç”¨'}</span></td>
                            <td>
                                <button class="btn btn-secondary btn-small" onclick="editProject('${p.id}')">ç¼–è¾‘</button>
                                <button class="btn btn-danger btn-small" onclick="deleteProject('${p.id}')">åˆ é™¤</button>
                            </td>
                        </tr>
                    `;
                }).join('') || '<tr><td colspan="5" style="text-align:center;color:var(--gray-500);">æš‚æ— é¡¹ç›®é…ç½®</td></tr>';
                
            } catch (error) {
                console.error('åŠ è½½é¡¹ç›®å¤±è´¥:', error);
            }
        }

        function showProjectModal(projectId = null) {
            document.getElementById('projectModalTitle').textContent = projectId ? 'ç¼–è¾‘é¡¹ç›®' : 'æ–°å¢é¡¹ç›®';
            document.getElementById('projectId').value = projectId || '';
            document.getElementById('projectName').value = '';
            document.getElementById('projectDays').value = '10';
            document.getElementById('projectActive').checked = true;
            document.getElementById('slotEditor').innerHTML = '';
            
            if (!projectId) {
                // æ·»åŠ é»˜è®¤æ—¶æ®µ
                addSlotRow('09:00-10:00', 5);
                addSlotRow('10:00-11:00', 5);
                addSlotRow('14:00-15:00', 5);
                addSlotRow('15:00-16:00', 5);
            }
            
            openModal('projectModal');
        }

        async function editProject(id) {
            const project = currentProjects.find(p => p.id === id) || 
                           await new AV.Query('Project').get(id);
            
            document.getElementById('projectModalTitle').textContent = 'ç¼–è¾‘é¡¹ç›®';
            document.getElementById('projectId').value = id;
            document.getElementById('projectName').value = project.get('name');
            document.getElementById('projectDays').value = project.get('availableDays');
            document.getElementById('projectActive').checked = project.get('active');
            
            document.getElementById('slotEditor').innerHTML = '';
            const slots = project.get('slots') || [];
            slots.forEach(s => addSlotRow(s.time, s.limit));
            
            openModal('projectModal');
        }

        function addSlotRow(time = '', limit = 5) {
            const container = document.getElementById('slotEditor');
            const row = document.createElement('div');
            row.className = 'slot-editor';
            row.innerHTML = `
                <div class="slot-editor-row">
                    <input type="text" class="slot-time" value="${time}" placeholder="æ—¶æ®µï¼Œå¦‚ 09:00-10:00">
                    <input type="number" class="slot-limit" value="${limit}" min="1" placeholder="äººæ•°é™åˆ¶">
                    <button type="button" onclick="this.parentElement.parentElement.remove()">âœ•</button>
                </div>
            `;
            container.appendChild(row);
        }

        async function saveProject() {
            const id = document.getElementById('projectId').value;
            const name = document.getElementById('projectName').value;
            const days = parseInt(document.getElementById('projectDays').value);
            const active = document.getElementById('projectActive').checked;
            
            const slots = [];
            document.querySelectorAll('.slot-editor').forEach(row => {
                const time = row.querySelector('.slot-time').value.trim();
                const limit = parseInt(row.querySelector('.slot-limit').value) || 5;
                if (time) {
                    slots.push({ time, limit });
                }
            });
            
            if (!name || !days || slots.length === 0) {
                showToast('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'error');
                return;
            }
            
            showLoading();
            
            try {
                let project;
                if (id) {
                    project = AV.Object.createWithoutData('Project', id);
                } else {
                    const Project = AV.Object.extend('Project');
                    project = new Project();
                }
                
                project.set('name', name);
                project.set('availableDays', days);
                project.set('slots', slots);
                project.set('active', active);
                
                await project.save();
                
                showToast('ä¿å­˜æˆåŠŸ', 'success');
                closeModal('projectModal');
                loadProjects();
                loadProjectsList();
                
            } catch (error) {
                showToast('ä¿å­˜å¤±è´¥ï¼š' + error.message, 'error');
            }
            
            hideLoading();
        }

        async function deleteProject(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¡¹ç›®å—ï¼Ÿ')) return;
            
            try {
                const project = AV.Object.createWithoutData('Project', id);
                await project.destroy();
                showToast('å·²åˆ é™¤', 'success');
                loadProjects();
                loadProjectsList();
            } catch (error) {
                showToast('åˆ é™¤å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // ==================== ç”¨æˆ·ç®¡ç†ï¼ˆè¶…çº§ç®¡ç†å‘˜ï¼‰ ====================
        async function loadUsers() {
            try {
                const query = new AV.Query('_User');
                query.descending('createdAt');
                const users = await query.find();
                
                // è·å–æ‰€æœ‰ç”¨æˆ·è§’è‰²
                const roleQuery = new AV.Query('UserRole');
                const roles = await roleQuery.find();
                const roleMap = {};
                roles.forEach(r => {
                    roleMap[r.get('user').id] = r.get('role');
                });
                
                const roleNames = {
                    'user': 'æ™®é€šç”¨æˆ·',
                    'admin': 'ç®¡ç†å‘˜',
                    'superadmin': 'è¶…çº§ç®¡ç†å‘˜'
                };
                
                const tbody = document.getElementById('usersTable');
                tbody.innerHTML = users.map(u => `
                    <tr>
                        <td>${u.get('username')}</td>
                        <td>${roleNames[roleMap[u.id] || 'user']}</td>
                        <td>${formatDateTime(u.createdAt)}</td>
                        <td>
                            <button class="btn btn-secondary btn-small" onclick="editUser('${u.id}')">ç¼–è¾‘</button>
                            <button class="btn btn-secondary btn-small" onclick="resetPassword('${u.id}')">é‡ç½®å¯†ç </button>
                            ${u.id !== currentUser.id ? 
                                `<button class="btn btn-danger btn-small" onclick="deleteUser('${u.id}')">åˆ é™¤</button>` : 
                                ''}
                        </td>
                    </tr>
                `).join('');
                
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·å¤±è´¥:', error);
            }
        }

        function showUserModal() {
            document.getElementById('userModalTitle').textContent = 'æ–°å¢ç”¨æˆ·';
            document.getElementById('userId').value = '';
            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('newUserRole').value = 'user';
            document.getElementById('passwordGroup').style.display = 'block';
            document.getElementById('newUsername').disabled = false;
            openModal('userModal');
        }

        async function editUser(id) {
            const query = new AV.Query('_User');
            const user = await query.get(id);
            
            const roleQuery = new AV.Query('UserRole');
            roleQuery.equalTo('user', user);
            const roleObj = await roleQuery.first();
            
            document.getElementById('userModalTitle').textContent = 'ç¼–è¾‘ç”¨æˆ·';
            document.getElementById('userId').value = id;
            document.getElementById('newUsername').value = user.get('username');
            document.getElementById('newUsername').disabled = true;
            document.getElementById('newPassword').value = '';
            document.getElementById('newUserRole').value = roleObj ? roleObj.get('role') : 'user';
            document.getElementById('passwordGroup').style.display = 'none';
            
            openModal('userModal');
        }

        async function saveUser() {
            const id = document.getElementById('userId').value;
            const username = document.getElementById('newUsername').value;
            const password = document.getElementById('newPassword').value;
            const role = document.getElementById('newUserRole').value;
            
            if (!username || (!id && !password)) {
                showToast('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'error');
                return;
            }
            
            showLoading();
            
            try {
                if (id) {
                    // æ›´æ–°è§’è‰²
                    const userQuery = new AV.Query('_User');
                    const user = await userQuery.get(id);
                    
                    const roleQuery = new AV.Query('UserRole');
                    roleQuery.equalTo('user', user);
                    let roleObj = await roleQuery.first();
                    
                    if (roleObj) {
                        roleObj.set('role', role);
                    } else {
                        const UserRole = AV.Object.extend('UserRole');
                        roleObj = new UserRole();
                        roleObj.set('user', user);
                        roleObj.set('role', role);
                    }
                    
                    await roleObj.save();
                } else {
                    // åˆ›å»ºæ–°ç”¨æˆ·
                    const user = new AV.User();
                    user.setUsername(username);
                    user.setPassword(password);
                    await user.signUp();
                    
                    // è®¾ç½®è§’è‰²
                    const UserRole = AV.Object.extend('UserRole');
                    const roleObj = new UserRole();
                    roleObj.set('user', user);
                    roleObj.set('role', role);
                    await roleObj.save();
                    
                    // é‡æ–°ç™»å½•å½“å‰ç”¨æˆ·
                    await AV.User.logIn(currentUser.get('username'), '');
                }
                
                showToast('ä¿å­˜æˆåŠŸ', 'success');
                closeModal('userModal');
                loadUsers();
                
            } catch (error) {
                showToast('ä¿å­˜å¤±è´¥ï¼š' + error.message, 'error');
            }
            
            hideLoading();
        }

        async function resetPassword(id) {
            const newPassword = prompt('è¯·è¾“å…¥æ–°å¯†ç ï¼š');
            if (!newPassword) return;
            
            try {
                // éœ€è¦é€šè¿‡äº‘å‡½æ•°æˆ–APIæ¥é‡ç½®å¯†ç 
                showToast('å¯†ç é‡ç½®åŠŸèƒ½éœ€è¦åç«¯æ”¯æŒ', 'warning');
            } catch (error) {
                showToast('é‡ç½®å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        async function deleteUser(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç”¨æˆ·å—ï¼Ÿ')) return;
            
            try {
                // åˆ é™¤è§’è‰²è®°å½•
                const userQuery = new AV.Query('_User');
                const user = await userQuery.get(id);
                
                const roleQuery = new AV.Query('UserRole');
                roleQuery.equalTo('user', user);
                const roleObj = await roleQuery.first();
                if (roleObj) {
                    await roleObj.destroy();
                }
                
                // åˆ é™¤ç”¨æˆ·ï¼ˆéœ€è¦ç®¡ç†æƒé™ï¼‰
                await user.destroy();
                
                showToast('å·²åˆ é™¤', 'success');
                loadUsers();
            } catch (error) {
                showToast('åˆ é™¤å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        function downloadUserTemplate() {
            const data = [
                { 'ç”¨æˆ·å': 'user1', 'å¯†ç ': '123456', 'è§’è‰²': 'user' },
                { 'ç”¨æˆ·å': 'admin1', 'å¯†ç ': '123456', 'è§’è‰²': 'admin' }
            ];
            
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ç”¨æˆ·æ¨¡æ¿');
            XLSX.writeFile(wb, 'ç”¨æˆ·å¯¼å…¥æ¨¡æ¿.xlsx');
        }

        async function importUsers(input) {
            const file = input.files[0];
            if (!file) return;
            
            showLoading();
            
            try {
                const data = await file.arrayBuffer();
                const wb = XLSX.read(data);
                const ws = wb.Sheets[wb.SheetNames[0]];
                const users = XLSX.utils.sheet_to_json(ws);
                
                let successCount = 0;
                let failCount = 0;
                
                for (const userData of users) {
                    try {
                        const user = new AV.User();
                        user.setUsername(userData['ç”¨æˆ·å']);
                        user.setPassword(userData['å¯†ç ']);
                        await user.signUp();
                        
                        const UserRole = AV.Object.extend('UserRole');
                        const roleObj = new UserRole();
                        roleObj.set('user', user);
                        roleObj.set('role', userData['è§’è‰²'] || 'user');
                        await roleObj.save();
                        
                        successCount++;
                    } catch (e) {
                        failCount++;
                    }
                }
                
                showToast(`å¯¼å…¥å®Œæˆï¼šæˆåŠŸ ${successCount} ä¸ªï¼Œå¤±è´¥ ${failCount} ä¸ª`, 'success');
                loadUsers();
                
            } catch (error) {
                showToast('å¯¼å…¥å¤±è´¥ï¼š' + error.message, 'error');
            }
            
            input.value = '';
            hideLoading();
        }

        // ==================== åˆå§‹åŒ– ====================
        initApp();

        // åˆ›å»ºåˆå§‹ç®¡ç†å‘˜ï¼ˆé¦–æ¬¡ä½¿ç”¨æ—¶å–æ¶ˆæ³¨é‡Šè¿è¡Œä¸€æ¬¡ï¼‰
        async function createInitialAdmin() {
            try {
                const user = new AV.User();
                user.setUsername('admin');
                user.setPassword('admin123');
                await user.signUp();
                
                const UserRole = AV.Object.extend('UserRole');
                const roleObj = new UserRole();
                roleObj.set('user', user);
                roleObj.set('role', 'superadmin');
                await roleObj.save();
                
                console.log('åˆå§‹ç®¡ç†å‘˜åˆ›å»ºæˆåŠŸ');
            } catch (error) {
                console.error('åˆ›å»ºå¤±è´¥:', error);
            }
        }
        // é¦–æ¬¡ä½¿ç”¨è¯·å–æ¶ˆä¸‹é¢è¿™è¡Œçš„æ³¨é‡Šï¼Œåˆ›å»ºç®¡ç†å‘˜åå†æ³¨é‡Šå›å»
     
    </script>
</body>
</html>
